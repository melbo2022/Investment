{% extends "base.html" %}
{% block title %}ローン計算 – 金融電卓{% endblock %}

{% block content %}
<h1 class="mb-3">ローン計算（元利均等・月末払い・固定金利）</h1>
<p class="text-muted small mb-3">借入金額 / 返済年数 / 月額返済額 / 金利のいずれか1つを解き、年次ダウンサンプリングした残高グラフを表示します（最終残存元本に対応）。</p>

<form method="post" action="{{ url_for('page_loan') }}" class="card p-3 mb-4">
  <div class="row g-3">
    <div class="col-12 col-md-4">
      <label class="form-label">解く対象</label>
      <select name="solve" class="form-select">
        <option value="payment" {{ 'selected' if request.form.get('solve','payment')=='payment' }}>月額返済額 PMT</option>
        <option value="amount"  {{ 'selected' if request.form.get('solve')=='amount'  }}>借入金額 L</option>
        <option value="years"   {{ 'selected' if request.form.get('solve')=='years'   }}>返済年数</option>
        <option value="rate"    {{ 'selected' if request.form.get('solve')=='rate'    }}>金利（年率）</option>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">借入金額 L</label>
      <input type="text" name="loan_amount" class="form-control" value="{{ request.form.get('loan_amount','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">返済年数（年）</label>
      <input type="text" name="years" class="form-control" value="{{ request.form.get('years','') }}">
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">月額返済額 PMT</label>
      <input type="text" name="monthly_payment" class="form-control" value="{{ request.form.get('monthly_payment','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">年率（%）</label>
      <input type="text" name="annual" class="form-control" value="{{ request.form.get('annual','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">最終残存元本（バルーン）B</label>
      <input type="text" name="residual" class="form-control" value="{{ request.form.get('residual','') }}">
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">計算</button>
    </div>
  </div>
</form>

{% if result %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">計算結果</h5>
      <div class="row">
        <div class="col-12 col-lg-6">
          <ul class="list-group list-group-flush">
            {% if result.solve == 'payment' %}
              <li class="list-group-item">月額返済額 PMT: <strong>{{ "{:,.2f}".format(result.monthly_payment) }}</strong></li>
              <li class="list-group-item">期間（月）: {{ result.n }}</li>
            {% elif result.solve == 'amount' %}
              <li class="list-group-item">借入金額 L: <strong>{{ "{:,.2f}".format(result.loan_amount) }}</strong></li>
              <li class="list-group-item">期間（月）: {{ result.n }}</li>
            {% elif result.solve == 'years' %}
              <li class="list-group-item">返済年数（年）: <strong>{{ result.years }}</strong></li>
              <li class="list-group-item">返済期間（月）: {{ result.months }}</li>
            {% elif result.solve == 'rate' %}
              <li class="list-group-item">年率（%）: <strong>{{ "{:,.6f}".format(result.annual_rate_pct) }}</strong></li>
              <li class="list-group-item">月率（%）: {{ "{:,.6f}".format(result.monthly_rate_pct) }}</li>
            {% endif %}
          </ul>
        </div>
        <div class="col-12 col-lg-6">
          <div class="border rounded p-3">
            <h6 class="mb-2">年次残高グラフ（ローン残高）</h6>
            <canvas id="loanChart"></canvas>
            <p class="text-muted small mb-0 mt-2">0年目は初期残高、以降は12ヶ月ごと（端数は最終月）。残高は見栄え上0未満を0に丸めています。</p>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if result and result.chart_labels and result.chart_data %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      const ctx = document.getElementById('loanChart');
      if (!ctx) return;
      const labels = {{ result.chart_labels | tojson }};
      const data = {{ result.chart_data | tojson }};
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: 'ローン残高', data, tension: 0.2 }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}

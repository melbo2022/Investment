{% extends "base.html" %}
{% block title %}貯蓄計算 – 金融電卓{% endblock %}

{% block content %}
<h1 class="mb-3">積立（貯蓄）計算</h1>
<p class="text-muted small mb-3">毎月拠出・月複利。FV / PV / PMT / 年数 / 金利のいずれか1つを解き、年次ダウンサンプリングした残高グラフを表示します。</p>

<form method="post" action="{{ url_for('page_savings') }}" class="card p-3 mb-4">
  <div class="row g-3">
    <div class="col-12 col-md-4">
      <label class="form-label">解く対象</label>
      <select name="solve" class="form-select">
        <option value="fv"   {{ 'selected' if request.form.get('solve','fv')=='fv' }}>FV（将来価値）</option>
        <option value="pv"   {{ 'selected' if request.form.get('solve')=='pv' }}>PV（現在元本）</option>
        <option value="pmt"  {{ 'selected' if request.form.get('solve')=='pmt' }}>PMT（毎月拠出）</option>
        <option value="years"{{ 'selected' if request.form.get('solve')=='years' }}>年数</option>
        <option value="rate" {{ 'selected' if request.form.get('solve')=='rate' }}>金利（年率）</option>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">目標FV</label>
      <input type="text" name="target_fv" class="form-control" value="{{ request.form.get('target_fv','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">現在元本 PV</label>
      <input type="text" name="pv" class="form-control" value="{{ request.form.get('pv','') }}">
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">毎月拠出 PMT</label>
      <input type="text" name="pmt" class="form-control" value="{{ request.form.get('pmt','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">年数（年）</label>
      <input type="text" name="years" class="form-control" value="{{ request.form.get('years','') }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">年率（%）</label>
      <input type="text" name="annual" class="form-control" value="{{ request.form.get('annual','') }}">
    </div>

    <div class="col-12">
      <label class="form-label me-3">拠出タイミング</label>
      {% set due_val = request.form.get('due','begin') %}
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="due" id="dueBegin" value="begin" {{ 'checked' if due_val=='begin' else '' }}>
        <label class="form-check-label" for="dueBegin">期首（毎月初）</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="due" id="dueEnd" value="end" {{ 'checked' if due_val=='end' else '' }}>
        <label class="form-check-label" for="dueEnd">期末（毎月末）</label>
      </div>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">計算</button>
    </div>
  </div>
</form>

{% if result %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">計算結果</h5>
      <div class="row">
        <div class="col-12 col-lg-6">
          <ul class="list-group list-group-flush">
            {% if result.solve == 'fv' %}
              <li class="list-group-item">将来価値 FV: <strong>{{ "{:,.2f}".format(result.fv) }}</strong></li>
              <li class="list-group-item">期間（月）: {{ result.months }}</li>
            {% elif result.solve == 'pv' %}
              <li class="list-group-item">必要PV: <strong>{{ "{:,.2f}".format(result.pv) }}</strong></li>
              <li class="list-group-item">期間（月）: {{ result.months }}</li>
            {% elif result.solve == 'pmt' %}
              <li class="list-group-item">必要PMT: <strong>{{ "{:,.2f}".format(result.pmt) }}</strong></li>
              <li class="list-group-item">期間（月）: {{ result.months }}</li>
            {% elif result.solve == 'years' %}
              <li class="list-group-item">必要年数（年）: <strong>{{ result.years }}</strong></li>
              <li class="list-group-item">必要期間（月）: {{ result.months }}</li>
            {% elif result.solve == 'rate' %}
              <li class="list-group-item">必要年率（%）: <strong>{{ "{:,.6f}".format(result.annual_rate_pct) }}</strong></li>
              <li class="list-group-item">必要月率（%）: {{ "{:,.6f}".format(result.monthly_rate_pct) }}</li>
              <li class="list-group-item">期間（月）: {{ result.months }}</li>
            {% endif %}
          </ul>
        </div>
        <div class="col-12 col-lg-6">
          <div class="border rounded p-3">
            <h6 class="mb-2">年次残高グラフ</h6>
            <canvas id="savingsChart"></canvas>
            <p class="text-muted small mb-0 mt-2">0年目は初期残高、以降は12ヶ月ごと（端数は最終月）。</p>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if result and result.chart_labels and result.chart_data %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      const ctx = document.getElementById('savingsChart');
      if (!ctx) return;
      const labels = {{ result.chart_labels | tojson }};
      const data = {{ result.chart_data | tojson }};
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: '残高', data, tension: 0.2 }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}
